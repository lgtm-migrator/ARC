

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arc.job.job &mdash; ARC 1.1.0 Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ARC
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../running.html">Running ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">ARCâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Standalone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../media.html">Media</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cite.html">How to cite ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licence.html">Licence</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ARC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>arc.job.job</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arc.job.job</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The ARC Job module</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">arc.common</span> <span class="kn">import</span> <span class="n">ARC_PATH</span><span class="p">,</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">arc.exceptions</span> <span class="kn">import</span> <span class="n">JobError</span><span class="p">,</span> <span class="n">InputError</span>
<span class="kn">from</span> <span class="nn">arc.imports</span> <span class="kn">import</span> <span class="n">settings</span><span class="p">,</span> <span class="n">input_files</span><span class="p">,</span> <span class="n">submit_scripts</span>
<span class="kn">from</span> <span class="nn">arc.job.local</span> <span class="kn">import</span> <span class="p">(</span><span class="n">get_last_modified_time</span><span class="p">,</span>
                           <span class="n">submit_job</span><span class="p">,</span>
                           <span class="n">delete_job</span><span class="p">,</span>
                           <span class="n">execute_command</span><span class="p">,</span>
                           <span class="n">check_job_status</span><span class="p">,</span>
                           <span class="n">rename_output</span><span class="p">,</span>
                           <span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.job.ssh</span> <span class="kn">import</span> <span class="n">SSHClient</span>
<span class="kn">from</span> <span class="nn">arc.job.trsh</span> <span class="kn">import</span> <span class="n">determine_ess_status</span><span class="p">,</span> <span class="n">trsh_job_on_server</span>
<span class="kn">from</span> <span class="nn">arc.level</span> <span class="kn">import</span> <span class="n">Level</span>
<span class="kn">from</span> <span class="nn">arc.plotter</span> <span class="kn">import</span> <span class="n">save_geo</span>
<span class="kn">from</span> <span class="nn">arc.species.converter</span> <span class="kn">import</span> <span class="n">check_xyz_dict</span><span class="p">,</span> <span class="n">xyz_to_str</span>
<span class="kn">from</span> <span class="nn">arc.species.vectors</span> <span class="kn">import</span> <span class="n">calculate_dihedral_angle</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<span class="n">default_job_settings</span><span class="p">,</span> <span class="n">servers</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">,</span> <span class="n">t_max_format</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> \
    <span class="n">rotor_scan_resolution</span><span class="p">,</span> <span class="n">orca_default_options_dict</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;default_job_settings&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">],</span> \
                                                       <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;submit_filename&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;t_max_format&#39;</span><span class="p">],</span> \
                                                       <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;input_filename&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;output_filename&#39;</span><span class="p">],</span> \
                                                       <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rotor_scan_resolution&#39;</span><span class="p">],</span> \
                                                       <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;orca_default_options_dict&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Job"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job">[docs]</a><span class="k">class</span> <span class="nc">Job</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ARC&#39;s Job class.</span>

<span class="sd">    Args:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the directory.</span>
<span class="sd">        project_directory (str): The path to the project directory.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        species_name (str): The species/TS name. Used for naming the directory.</span>
<span class="sd">        xyz (dict): The xyz geometry. Used for the calculation.</span>
<span class="sd">        job_type (str): The job&#39;s type.</span>
<span class="sd">        level (Level, dict, str): The level of theory to use.</span>
<span class="sd">        multiplicity (int): The species multiplicity.</span>
<span class="sd">        charge (int, optional): The species net charge. Default is 0.</span>
<span class="sd">        conformer (int, optional): Conformer number if optimizing conformers.</span>
<span class="sd">        fine (bool, optional): Whether to use fine geometry optimization parameters.</span>
<span class="sd">        shift (str, optional): A string representation alpha- and beta-spin orbitals shifts (molpro only).</span>
<span class="sd">        software (str, optional): The electronic structure software to be used.</span>
<span class="sd">        is_ts (bool): Whether this species represents a transition structure. Default: ``False``.</span>
<span class="sd">        scan (list, optional): A list representing atom labels for the dihedral scan</span>
<span class="sd">                              (e.g., &quot;2 1 3 5&quot; as a string or [2, 1, 3, 5] as a list of integers).</span>
<span class="sd">        pivots (list, optional): The rotor scan pivots, if the job type is scan. Not used directly in these methods,</span>
<span class="sd">                                 but used to identify the rotor.</span>
<span class="sd">        total_job_memory_gb (int, optional): The total job allocated memory in GB (14 by default).</span>
<span class="sd">        comments (str, optional): Job comments (archived, not used).</span>
<span class="sd">        args (str, dict optional): Methods (including troubleshooting) to be used in input files.</span>
<span class="sd">                                   Keys are either &#39;keyword&#39; or &#39;block&#39;, values are dictionaries with values to be used</span>
<span class="sd">                                   either as keywords or as blocks in the respective software input file. If ``args``</span>
<span class="sd">                                   attribute is given as a string, it will be converted to a dictionary format with</span>
<span class="sd">                                   &#39;keyword&#39; and &#39;general&#39; key.</span>
<span class="sd">        scan_trsh (str, optional): A troubleshooting method for rotor scans.</span>
<span class="sd">        ess_trsh_methods (list, optional): A list of troubleshooting methods already tried out for ESS convergence.</span>
<span class="sd">        bath_gas (str, optional): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                                  Allowed values are He, Ne, Ar, Kr, H2, N2, O2</span>
<span class="sd">        job_num (int, optional): Used as the entry number in the database, as well as the job name on the server.</span>
<span class="sd">        job_server_name (str, optional): Job&#39;s name on the server (e.g., &#39;a103&#39;).</span>
<span class="sd">        job_name (str, optional): Job&#39;s name for internal usage (e.g., &#39;opt_a103&#39;).</span>
<span class="sd">        job_id (int, optional): The job&#39;s ID determined by the server.</span>
<span class="sd">        server (str, optional): Server&#39;s name.</span>
<span class="sd">        initial_time (datetime, optional): The date-time this job was initiated.</span>
<span class="sd">        occ (int, optional): The number of occupied orbitals (core + val) from a molpro CCSD sp calc.</span>
<span class="sd">        max_job_time (float, optional): The maximal allowed job time on the server in hours (can be fractional).</span>
<span class="sd">        scan_res (int, optional): The rotor scan resolution in degrees.</span>
<span class="sd">        checkfile (str, optional): The path to a previous Gaussian checkfile to be used in the current job.</span>
<span class="sd">        number_of_radicals (int, optional): The number of radicals (inputted by the user, ARC won&#39;t attempt to</span>
<span class="sd">                                            determine it). Defaults to None. Important, e.g., if a Species is a bi-rad</span>
<span class="sd">                                            singlet, in which case the job should be unrestricted with</span>
<span class="sd">                                            multiplicity = 1.</span>
<span class="sd">        radius (float, optional): The species radius in Angstrom.</span>
<span class="sd">        directed_scans (list): Entries are lists of four-atom dihedral scan indices to constrain during a directed scan.</span>
<span class="sd">        directed_dihedrals (list): The dihedral angles of a directed scan job corresponding to ``directed_scans``.</span>
<span class="sd">        directed_scan_type (str): The type of the directed scan.</span>
<span class="sd">        rotor_index (int): The 0-indexed rotor number (key) in the species.rotors_dict dictionary.</span>
<span class="sd">        testing (bool, optional): Whether the object is generated for testing purposes, True if it is.</span>
<span class="sd">        cpu_cores (int, optional): The total number of cpu cores requested for a job.</span>
<span class="sd">        irc_direction (str, optional): The direction of the IRC job (`forward` or `reverse`).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the directory.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        species_name (str): The species/TS name. Used for naming the directory.</span>
<span class="sd">        charge (int): The species net charge. Default is 0.</span>
<span class="sd">        multiplicity (int): The species multiplicity.</span>
<span class="sd">        number_of_radicals (int): The number of radicals (inputted by the user, ARC won&#39;t attempt to determine it).</span>
<span class="sd">                                  Defaults to None. Important, e.g., if a Species is a bi-rad singlet, in which case</span>
<span class="sd">                                  the job should be unrestricted with multiplicity = 1.</span>
<span class="sd">        spin (int): The spin. automatically derived from the multiplicity.</span>
<span class="sd">        xyz (dict): The xyz geometry. Used for the calculation.</span>
<span class="sd">        radius (float): The species radius in Angstrom.</span>
<span class="sd">        n_atoms (int): The number of atoms in self.xyz.</span>
<span class="sd">        conformer (int): Conformer number if optimizing conformers.</span>
<span class="sd">        is_ts (bool): Whether this species represents a transition structure.</span>
<span class="sd">        level (Level): The level of theory to use.</span>
<span class="sd">        job_type (str): The job&#39;s type.</span>
<span class="sd">        scan (list): A list representing atom labels for the dihedral scan (e.g., [2, 1, 3, 5]).</span>
<span class="sd">        pivots (list): The rotor scan pivots, if the job type is scan. Not used directly in these methods,</span>
<span class="sd">                       but used to identify the rotor.</span>
<span class="sd">        scan_res (int): The rotor scan resolution in degrees.</span>
<span class="sd">        software (str): The electronic structure software to be used.</span>
<span class="sd">        server_nodes (list): A list of nodes this job was submitted to (for troubleshooting).</span>
<span class="sd">        cpu_cores (int): The total number of cpu cores requested for a job.</span>
<span class="sd">                         ARC adopts the following naming system to describe computing hardware hierarchy</span>
<span class="sd">                         node &gt; cpu &gt; cpu_cores &gt; cpu_threads</span>
<span class="sd">        input_file_memory (int): The memory ARC writes to job input files in appropriate formats per ESS.</span>
<span class="sd">                                 In software like Gaussian, this variable is total memory for all cpu cores.</span>
<span class="sd">                                 In software like Orca, this variable is memory per cpu core.</span>
<span class="sd">        submit_script_memory (int): The memory ARC writes to submit script in appropriate formats per cluster system.</span>
<span class="sd">                                    In system like Sun Grid Engine, this variable is total memory for all cpu cores.</span>
<span class="sd">                                    In system like Slurm, this variable is memory per cpu core.</span>
<span class="sd">                                    Notice that submit_script_memory &gt; input_file_memory because additional memory is</span>
<span class="sd">                                    needed to execute a job on server properly</span>
<span class="sd">        total_job_memory_gb (int): The total memory ARC specifies for a job in GB.</span>
<span class="sd">        fine (bool): Whether to use fine geometry optimization parameters.</span>
<span class="sd">        shift (str): A string representation alpha- and beta-spin orbitals shifts (molpro only).</span>
<span class="sd">        comments (str): Job comments (archived, not used).</span>
<span class="sd">        initial_time (datetime): The date-time this job was initiated.</span>
<span class="sd">        final_time (datetime): The date-time this job was initiated.</span>
<span class="sd">        run_time (timedelta): Job execution time.</span>
<span class="sd">        job_status (list): The job&#39;s server and ESS statuses.</span>
<span class="sd">                           The job server status is in job.job_status[0] and can be either &#39;initializing&#39; / &#39;running&#39;</span>
<span class="sd">                           / &#39;errored&#39; / &#39;done&#39;. The job ESS status is in job.job_status[1] is a dictionary of</span>
<span class="sd">                           {&#39;status&#39;: str, &#39;keywords&#39;: list, &#39;error&#39;: str, &#39;line&#39;: str}.</span>
<span class="sd">                           The values of &#39;status&#39; can be either `initializing`, `running`, `errored`, `unconverged`,</span>
<span class="sd">                           or `done`. If the status is &#39;errored&#39;, then standardized error keywords, the error</span>
<span class="sd">                           description and the identified error line from the ESS log file will be given as well.</span>
<span class="sd">        job_server_name (str): Job&#39;s name on the server (e.g., &#39;a103&#39;).</span>
<span class="sd">        job_name (str): Job&#39;s name for internal usage (e.g., &#39;opt_a103&#39;).</span>
<span class="sd">        job_id (int): The job&#39;s ID determined by the server.</span>
<span class="sd">        job_num (int): Used as the entry number in the database, as well as the job name on the server.</span>
<span class="sd">        local_path (str): Local path to job&#39;s folder.</span>
<span class="sd">        local_path_to_output_file (str): The local path to the output.out file.</span>
<span class="sd">        local_path_to_orbitals_file (str): The local path to the orbitals.fchk file (only for orbitals jobs).</span>
<span class="sd">        local_path_to_check_file (str): The local path to the Gaussian check file of the current job (downloaded).</span>
<span class="sd">        local_path_to_lj_file (str): The local path to the lennard_jones data file (from OneDMin).</span>
<span class="sd">        local_path_to_xyz (str) The local path to the optimization results file if different than the log file.</span>
<span class="sd">        checkfile (str): The path to a previous Gaussian checkfile to be used in the current job.</span>
<span class="sd">        remote_path (str): Remote path to job&#39;s folder.</span>
<span class="sd">        submit (str): The submit script. Created automatically.</span>
<span class="sd">        input (str): The input file. Created automatically.</span>
<span class="sd">        server (str): Server&#39;s name.</span>
<span class="sd">        args (dict): Methods (including troubleshooting) to be used in input files. Keys are either &#39;keyword&#39; or</span>
<span class="sd">                     &#39;block&#39;, values are dictionaries with values to be used either as keywords or as blocks in the</span>
<span class="sd">                     respective software input file.</span>
<span class="sd">        ess_trsh_methods (list): A list of troubleshooting methods already tried out for ESS convergence.</span>
<span class="sd">        scan_trsh (str): A troubleshooting method for rotor scans.</span>
<span class="sd">        occ (int): The number of occupied orbitals (core + val) from a molpro CCSD sp calc.</span>
<span class="sd">        project_directory (str): The path to the project directory.</span>
<span class="sd">        max_job_time (float): The maximal allowed job time on the server in hours (can be fractional).</span>
<span class="sd">        bath_gas (str): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                        Allowed values are He, Ne, Ar, Kr, H2, N2, O2.</span>
<span class="sd">        directed_scans (list): Entries are lists of four-atom dihedral scan indices to constrain during a directed scan.</span>
<span class="sd">        directed_dihedrals (list): The dihedral angles of a directed scan job corresponding to ``directed_scans``.</span>
<span class="sd">        directed_scan_type (str): The type of the directed scan.</span>
<span class="sd">        rotor_index (int): The 0-indexed rotor number (key) in the species.rotors_dict dictionary.</span>
<span class="sd">        irc_direction (str): The direction of the IRC job (`forward` or `reverse`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">project_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">species_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">multiplicity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">level</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Level</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                 <span class="n">ess_settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                 <span class="n">xyz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">charge</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">conformer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">fine</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">shift</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">software</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">is_ts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">scan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">pivots</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">total_job_memory_gb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">comments</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">scan_trsh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">ess_trsh_methods</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">bath_gas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_num</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_server_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">server</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">server_nodes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">initial_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">final_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">occ</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_job_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">scan_res</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">checkfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">number_of_radicals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">radius</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">directed_scan_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">directed_scans</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">directed_dihedrals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">rotor_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">testing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">cpu_cores</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">irc_direction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span> <span class="o">=</span> <span class="n">project_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span> <span class="o">=</span> <span class="n">species_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">job_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">Level</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span> <span class="o">=</span> <span class="n">ess_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">initial_time</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_time</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">initial_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">final_time</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_time</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">final_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_num</span> <span class="o">=</span> <span class="n">job_num</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="o">=</span> <span class="n">number_of_radicals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="o">=</span> <span class="n">directed_scan_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">directed_dihedrals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directed_dihedrals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">directed_dihedrals</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">directed_dihedrals</span><span class="p">]</span>  <span class="c1"># it&#39;s a string in the restart dict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rotor_index</span> <span class="o">=</span> <span class="n">rotor_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span> <span class="o">=</span> <span class="n">directed_scans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">directed_dihedrals</span><span class="p">]</span> <span class="k">if</span> <span class="n">directed_dihedrals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">directed_scans</span>  <span class="c1"># it&#39;s a string in the restart dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">=</span> <span class="n">conformer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span> <span class="o">=</span> <span class="n">is_ts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;general&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">}}</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">args</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key1</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_trsh</span> <span class="o">=</span> <span class="n">scan_trsh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span> <span class="o">=</span> <span class="n">scan_res</span> <span class="ow">or</span> <span class="n">rotor_scan_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivots</span> <span class="o">=</span> <span class="n">pivots</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="n">max_job_time</span> <span class="ow">or</span> <span class="n">default_job_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;job_time_limit_hrs&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="o">=</span> <span class="n">bath_gas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="n">testing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fine</span> <span class="o">=</span> <span class="n">fine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occ</span> <span class="o">=</span> <span class="n">occ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span> <span class="o">=</span> <span class="n">job_status</span> \
            <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;initializing&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;initializing&#39;</span><span class="p">,</span> <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">checkfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_nodes</span> <span class="o">=</span> <span class="n">server_nodes</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span> <span class="o">=</span> <span class="n">job_server_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="n">software</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deduce_software</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span> <span class="o">=</span> <span class="n">cpu_cores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span> <span class="o">=</span> <span class="n">total_job_memory_gb</span> <span class="ow">or</span> <span class="n">default_job_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;job_total_memory_gb&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irc_direction</span> <span class="o">=</span> <span class="n">irc_direction</span>

        <span class="c1"># allowed job types:</span>
        <span class="n">job_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">,</span> <span class="s1">&#39;bde&#39;</span><span class="p">,</span> <span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;gsm&#39;</span><span class="p">,</span> <span class="s1">&#39;irc&#39;</span><span class="p">,</span> <span class="s1">&#39;ts_guess&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitals&#39;</span><span class="p">,</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Job type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> not understood. Must be one of the following:</span><span class="se">\n</span><span class="si">{</span><span class="n">job_types</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> Job of species </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="si">}</span><span class="s1"> got None for xyz&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;directed_scan&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span> <span class="ow">is</span> <span class="kc">None</span>
                                                 <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Must have the directed_dihedrals, directed_scans, and directed_scan_type attributes &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;for a directed scan job. Got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span><span class="si">}</span><span class="s1">, &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="si">}</span><span class="s1">, respectively.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;directed_scan&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotor_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Must have the rotor_index argument for a directed scan job.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_job_number</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span> <span class="ow">or</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_num</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conformer</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;conformer_a&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;replacing job name </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> with conformer_</span><span class="si">{</span><span class="n">conformer</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;conformer</span><span class="si">{</span><span class="n">conformer</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting bath gas for Lennard-Jones calculation to N2 for species </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="o">=</span> <span class="s1">&#39;N2&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="s1">&#39;Ne&#39;</span><span class="p">,</span> <span class="s1">&#39;Ar&#39;</span><span class="p">,</span> <span class="s1">&#39;Kr&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="s1">&#39;N2&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bath gas for OneDMin should be one of the following:</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;He, Ne, Ar, Kr, H2, N2, O2.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit_script_memory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_file_memory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cpu_and_mem</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_run_time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_file_paths</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">job_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this checks job_num and not self.job_num on purpose</span>
            <span class="c1"># if job_num was given, then don&#39;t save as initiated jobs, this is a restarted job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_initiated_job_to_csv_file</span><span class="p">()</span>

<div class="viewcode-block" id="Job.as_dict"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for dumping this object as a dictionary in a YAML file for restarting ARC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;project_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;species_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;multiplicity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;ess_settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;total_job_memory_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span><span class="p">)</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_num</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_server_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;max_job_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;cpu_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;scan_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;is_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;software&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivots</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivots</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_trsh</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;scan_trsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_trsh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;ess_trsh_methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;bath_gas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;initial_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;final_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_nodes</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;server_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_nodes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;number_of_radicals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">occ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occ</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;directed_dihedrals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dihedral</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                                              <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="p">]</span>
                                              <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;directed_scans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scan_type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotor_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;rotor_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotor_index</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;checkfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">irc_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;irc_direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">irc_direction</span>
        <span class="k">return</span> <span class="n">job_dict</span></div>

    <span class="k">def</span> <span class="nf">_set_job_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used as the entry number in the database, as well as the job name on the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ARC_PATH</span><span class="p">,</span> <span class="s1">&#39;initiated_jobs.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
            <span class="c1"># check file, make index file and write headers if file doesn&#39;t exists</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;job_num&#39;</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;species_name&#39;</span><span class="p">,</span> <span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;is_ts&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplicity&#39;</span><span class="p">,</span> <span class="s1">&#39;job_type&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;software&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;basis_set&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">]</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
            <span class="n">job_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">job_num</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">job_num</span> <span class="o">==</span> <span class="mi">100000</span><span class="p">:</span>
                    <span class="n">job_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_num</span> <span class="o">=</span> <span class="n">job_num</span>

    <span class="k">def</span> <span class="nf">_write_initiated_job_to_csv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an initiated ARCJob into the initiated_jobs.csv file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ARC_PATH</span><span class="p">,</span> <span class="s1">&#39;initiated_jobs.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is not a conformer search job</span>
            <span class="n">conformer</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conformer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="n">conformer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">]</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<div class="viewcode-block" id="Job.write_completed_job_to_csv_file"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.write_completed_job_to_csv_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_completed_job_to_csv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a completed ARCJob into the completed_jobs.csv file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">determine_job_status</span><span class="p">()</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ARC_PATH</span><span class="p">,</span> <span class="s1">&#39;completed_jobs.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
            <span class="c1"># check file, make index file and write headers if file doesn&#39;t exists</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;job_num&#39;</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;species_name&#39;</span><span class="p">,</span> <span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;is_ts&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplicity&#39;</span><span class="p">,</span> <span class="s1">&#39;job_type&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;software&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;basis_set&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_time&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;final_time&#39;</span><span class="p">,</span> <span class="s1">&#39;run_time&#39;</span><span class="p">,</span> <span class="s1">&#39;job_status_(server)&#39;</span><span class="p">,</span> <span class="s1">&#39;job_status_(ESS)&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ESS troubleshooting methods used&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">]</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ARC_PATH</span><span class="p">,</span> <span class="s1">&#39;completed_jobs.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is not a conformer search job</span>
            <span class="n">conformer</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conformer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
            <span class="n">job_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                <span class="n">job_type</span> <span class="o">+=</span> <span class="s1">&#39; (fine)&#39;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="n">conformer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">]</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="Job.format_max_job_time"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.format_max_job_time">[docs]</a>    <span class="k">def</span> <span class="nf">format_max_job_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the max_job_time attribute into the format supported by the server submission script</span>

<span class="sd">        Args:</span>
<span class="sd">            time_format (str): Either &#39;days&#39; (e.g., 5-0:00:00) or &#39;hours&#39; (e.g., 120:00:00)</span>

<span class="sd">        Returns: str</span>
<span class="sd">            The formatted maximum job time string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t_delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_format</span> <span class="o">==</span> <span class="s1">&#39;days&#39;</span><span class="p">:</span>
            <span class="c1"># e.g., 5-0:00:00</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_delta</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">t_delta</span><span class="o">.</span><span class="n">seconds</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">time_format</span> <span class="o">==</span> <span class="s1">&#39;hours&#39;</span><span class="p">:</span>
            <span class="c1"># e.g., 120:00:00</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">t_delta</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">+=</span> <span class="n">t_delta</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not determine format for maximal job time.</span><span class="se">\n</span><span class="s1"> Format is determined by </span><span class="si">{0}</span><span class="s1">, but &#39;</span>
                           <span class="s1">&#39;got </span><span class="si">{1}</span><span class="s1"> for </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_max_format</span><span class="p">,</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">t_max</span></div>

<div class="viewcode-block" id="Job.write_submit_script"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.write_submit_script">[docs]</a>    <span class="k">def</span> <span class="nf">write_submit_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the Job&#39;s submit script.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">un</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;un&#39;</span><span class="p">]</span>  <span class="c1"># user name</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">&gt;</span> <span class="mi">9999</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting max_job_time to 120 hours&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="mi">120</span>
        <span class="n">t_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_max_job_time</span><span class="p">(</span><span class="n">time_format</span><span class="o">=</span><span class="n">t_max_format</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]])</span>
        <span class="n">architecture</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pharos&#39;</span><span class="p">:</span>
            <span class="c1"># here we&#39;re hard-coding ARC for Pharos, a Green Group server</span>
            <span class="c1"># If your server has different node architectures, implement something similar</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">architecture</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#$ -l harpertown&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">architecture</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#$ -l magnycours&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit</span> <span class="o">=</span> <span class="n">submit_scripts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span><span class="p">,</span> <span class="n">un</span><span class="o">=</span><span class="n">un</span><span class="p">,</span> <span class="n">t_max</span><span class="o">=</span><span class="n">t_max</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_script_memory</span><span class="p">),</span>
                <span class="n">cpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">,</span> <span class="n">architecture</span><span class="o">=</span><span class="n">architecture</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">submit_scripts_for_printing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">server</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">submit_scripts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">submit_scripts_for_printing</span><span class="p">[</span><span class="n">server</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">software</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">submit_scripts_for_printing</span><span class="p">[</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">software</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find submit script for server </span><span class="si">{0}</span><span class="s1"> and software </span><span class="si">{1}</span><span class="s1">. Make sure your submit scripts &#39;</span>
                         <span class="s1">&#39;(in arc/job/submit.py) are updated with the servers and software defined in settings.py</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Alternatively, It is possible that you defined parameters in curly braces (e.g., {{PARAM}}) &#39;</span>
                         <span class="s1">&#39;in your submit script/s. To avoid error, replace them with double curly braces (e.g., &#39;</span>
                         <span class="s1">&#39;{{{{PARAM}}}} instead of {{PARAM}}.</span><span class="se">\n</span><span class="s1">Identified the following submit scripts:</span><span class="se">\n</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">submit_scripts_for_printing</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_upload_submit_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="Job.write_input_file"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.write_input_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a software-specific, job-specific input file.</span>
<span class="sd">        Save the file locally and also upload it to the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize variables</span>
        <span class="n">orca_options_keywords_dict</span><span class="p">,</span> <span class="n">orca_options_blocks_dict</span><span class="p">,</span> <span class="n">restricted</span><span class="p">,</span> <span class="n">method_class</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="c1"># Ignore user specified additional job arguments when troubleshoot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;When troubleshooting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">, ARC ignores the following user-specified options:</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">args</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">slash</span><span class="p">,</span> <span class="n">slash_2</span><span class="p">,</span> <span class="n">scan_string</span><span class="p">,</span> <span class="n">constraint</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">basis</span><span class="p">:</span>
            <span class="c1"># assume method without basis set is composite method or force field</span>
            <span class="n">slash</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">auxiliary_basis</span><span class="p">:</span>
                <span class="n">slash_2</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;semiempirical&#39;</span><span class="p">,</span> <span class="s1">&#39;force_field&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Determine HF/DFT restriction type</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">basis</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># run an unrestricted electronic structure calculation if the spin multiplicity is greater than one,</span>
            <span class="c1"># or if it is one but the number of radicals is greater than one (e.g., bi-rad singlet)</span>
            <span class="c1"># don&#39;t run unrestricted for composite methods such as CBS-QB3, it&#39;ll be done automatically if the</span>
            <span class="c1"># multiplicity is greater than one, but do specify uCBS-QB3 for example for bi-rad singlets.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using an unrestricted method for species </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="si">}</span><span class="s1"> which has &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span><span class="si">}</span><span class="s1"> radicals and multiplicity </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>  <span class="c1"># In QChem this attribute is &quot;unrestricted&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="s1">&#39;molpro&#39;</span><span class="p">]:</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;u&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>  <span class="c1"># In QChem this attribute is &quot;unrestricted&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># gaussian, molpro</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
            <span class="c1"># TeraChem does not accept &quot;wb97xd3&quot;, it expects to get &quot;wb97x&quot; as the method and &quot;d3&quot; as the dispersion</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;d2&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">=</span> <span class="s1">&#39;d2&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;d3&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">=</span> <span class="s1">&#39;d3&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">dispersion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">dispersion</span>

        <span class="n">job_type_1</span><span class="p">,</span> <span class="n">job_type_2</span><span class="p">,</span> <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># &#39;vdz&#39; troubleshooting in molpro:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">and</span> <span class="s1">&#39;keyword&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="s1">&#39;trsh&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="s1">&#39;vdz&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">][</span><span class="s1">&#39;trsh&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">][</span><span class="s1">&#39;trsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">][</span><span class="s1">&#39;trsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;vdz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;***,name</span>
<span class="s2">memory,</span><span class="si">{memory}</span><span class="s2">,m;</span>
<span class="s2">geometry={{angstrom;</span>
<span class="si">{xyz}</span><span class="s2"></span>
<span class="s2">}}</span>

<span class="s2">basis=cc-pVDZ</span>
<span class="s2">int;</span>
<span class="s2">{{hf;</span><span class="si">{shift}</span><span class="s2"></span>
<span class="s2">maxit,1000;</span>
<span class="s2">wf,spin=</span><span class="si">{spin}</span><span class="s2">,charge=</span><span class="si">{charge}</span><span class="s2">;}}</span>

<span class="si">{restricted}{method}</span><span class="s2">;</span>
<span class="si">{job_type_1}</span><span class="s2"></span>
<span class="si">{job_type_2}</span><span class="s2"></span>
<span class="s2">---;&quot;&quot;&quot;</span>

        <span class="c1"># Software specific global job options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
            <span class="n">orca_options_keywords_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">orca_options_blocks_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">user_scf_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">user_block_keywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;general&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">user_block_keywords</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">user_block_keywords</span><span class="p">:</span>
                    <span class="n">orca_options_blocks_dict</span><span class="p">[</span><span class="s1">&#39;global_general&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_block_keywords</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">user_keywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;general&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">user_keywords</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">user_keywords</span><span class="p">:</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;global_general&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_keywords</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">user_scf_convergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scf_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">user_scf_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">scf_convergence</span> <span class="o">=</span> <span class="n">user_scf_convergence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> \
                <span class="n">orca_default_options_dict</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scf_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scf_convergence</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Orca SCF convergence is not specified. Please specify this variable either in the &#39;</span>
                                 <span class="s1">&#39;settings.py as default options or in the input file as additional options.&#39;</span><span class="p">)</span>
            <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;scf_convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scf_convergence</span>

            <span class="c1"># Orca requires different job_options_blocks to wavefunction methods and DFTs</span>
            <span class="c1"># determine model chemistry type</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method_type</span> <span class="o">==</span> <span class="s1">&#39;dft&#39;</span><span class="p">:</span>
                <span class="n">method_class</span> <span class="o">=</span> <span class="s1">&#39;KS&#39;</span>
                <span class="c1"># DFT grid must be the same for both opt and freq</span>
                <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;dft_final_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NoFinalGrid&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;dft_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Grid6&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;dft_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Grid5&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method_type</span> <span class="o">==</span> <span class="s1">&#39;wavefunction&#39;</span><span class="p">:</span>
                <span class="n">method_class</span> <span class="o">=</span> <span class="s1">&#39;HF&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;dlpno&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                    <span class="n">user_dlpno_threshold</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">user_dlpno_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dlpno_threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">user_dlpno_threshold</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">dlpno_threshold</span> <span class="o">=</span> <span class="n">user_dlpno_threshold</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user_dlpno_threshold</span> \
                        <span class="k">else</span> <span class="n">orca_default_options_dict</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dlpno_threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dlpno_threshold</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                            <span class="s1">&#39;Orca DLPNO threshold is not specified. Please specify this variable either in the &#39;</span>
                            <span class="s1">&#39;settings.py as default options or in the input file as additional options.&#39;</span><span class="p">)</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;dlpno_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlpno_threshold</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> method in Orca.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ro&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;use=L506&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># xqc will do qc (quadratic convergence) if the job fails w/o it, so use by default</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;scf=xqc&#39;</span><span class="p">)</span>

        <span class="c1"># Job type specific options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, maxcycles=100)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(calcfc)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="c1"># Note that the Acc2E argument is not available in Gaussian03</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, tight, maxstep=5, maxcycles=100)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(tight, calcfc, maxstep=5)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_GRADIENT 15</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_DISPLACEMENT 60</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_ENERGY 5&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method_type</span> <span class="o">==</span> <span class="s1">&#39;dft&#39;</span><span class="p">:</span>
                        <span class="c1"># Try to capture DFT levels, and use a fine DFT grid</span>
                        <span class="c1"># See 4.4.5.2 Standard Quadrature Grids, S in</span>
                        <span class="c1"># http://www.q-chem.com/qchem-website/manual/qchem50_manual/sect-DFT.html</span>
                        <span class="n">fine</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   XC_GRID 3&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">optg, root=2, method=qsd, readhess, savexyz=&#39;geometry.xyz&#39;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">optg, savexyz=&#39;geometry.xyz&#39;&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">user_fine_opt_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">user_fine_opt_convergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fine_opt_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">user_fine_opt_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">fine_opt_convergence</span> <span class="o">=</span> <span class="n">user_fine_opt_convergence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user_fine_opt_convergence</span> \
                        <span class="k">else</span> <span class="n">orca_default_options_dict</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fine_opt_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fine_opt_convergence</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                            <span class="s1">&#39;Orca fine optimization convergence is not specified. Please specify this variable either &#39;</span>
                            <span class="s1">&#39;in the settings.py as default options or in the input file as additional options.&#39;</span><span class="p">)</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;fine_opt_convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fine_opt_convergence</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">user_opt_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">user_opt_convergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opt_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">user_opt_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">opt_convergence</span> <span class="o">=</span> <span class="n">user_opt_convergence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user_opt_convergence</span> \
                        <span class="k">else</span> <span class="n">orca_default_options_dict</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opt_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt_convergence</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                            <span class="s1">&#39;Orca optimization convergence is not specified. Please specify this variable either in &#39;</span>
                            <span class="s1">&#39;the settings.py as default options or in the input file as additional options.&#39;</span><span class="p">)</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;opt_convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt_convergence</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;OptTS&#39;</span>
                    <span class="n">orca_options_blocks_dict</span><span class="p">[</span><span class="s1">&#39;Calc_Hess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">%g</span><span class="s2">eom</span>
<span class="s2">    Calc_Hess true # calculation of the exact Hessian before the first opt step</span>
<span class="s2">end               </span>
<span class="s2">&quot;&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;Opt&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orca_options_keywords_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orca_options_blocks_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                 <span class="n">key1</span><span class="o">=</span><span class="s1">&#39;block&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;TeraChem does not perform TS optimization jobs&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;minimize</span><span class="se">\n</span><span class="s1">new_minimizer yes&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;4</span><span class="se">\n</span><span class="s1">dynamicgrid yes&#39;</span>  <span class="c1"># corresponds to ~60,000 grid points/atom</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>  <span class="c1"># default, corresponds to ~800 grid points/atom</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;orbitals&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   NBO           TRUE</span><span class="se">\n</span><span class="s1">   RUN_NBO6      TRUE</span><span class="se">\n</span><span class="s1">   &#39;</span>
                                 <span class="s1">&#39;PRINT_ORBITALS  TRUE</span><span class="se">\n</span><span class="s1">   GUI           2&#39;</span><span class="p">,</span>
                             <span class="n">key1</span><span class="o">=</span><span class="s1">&#39;block&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;freq&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;freq iop(7/33=1) scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;freq&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{frequencies;</span><span class="se">\n</span><span class="s1">thermo;</span><span class="se">\n</span><span class="s1">print,HESSIAN,thermo;}&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;Freq&#39;</span>
                <span class="n">use_num_freq</span> <span class="o">=</span> <span class="n">orca_default_options_dict</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_num_freq&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">use_num_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_num_freq&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">use_num_freq</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">use_num_freq</span><span class="p">:</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;freq_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NumFreq&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using numerical frequencies calculation in Orca. Note: This job might therefore be &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;time-consuming.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orca_options_keywords_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;frequencies&#39;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, maxstep=5, maxcycles=100)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(calcfc, noeigentest)&#39;</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;freq iop(7/33=1)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, tight, maxstep=5, maxcycles=100)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(calcfc, noeigentest, tight)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;@@@</span>

<span class="s2">$molecule</span>
<span class="s2">   read</span>
<span class="s2">$end</span>

<span class="s2">$rem</span>
<span class="s2">   JOBTYPE       </span><span class="si">{job_type_2}</span><span class="s2"></span>
<span class="s2">   METHOD        </span><span class="si">{method}</span><span class="s2"></span>
<span class="s2">   UNRESTRICTED  </span><span class="si">{restricted}</span><span class="s2"></span>
<span class="s2">   BASIS         </span><span class="si">{basis}</span><span class="s2"></span>
<span class="s2">   SCF_GUESS     read</span>
<span class="s2">$end</span>

<span class="s2">&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;freq&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_GRADIENT 15</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_DISPLACEMENT 60</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_ENERGY 5&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">optg,root=2,method=qsd,readhess,savexyz=&#39;geometry.xyz&#39;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">optg,savexyz=&#39;geometry.xyz&quot;</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{frequencies;</span><span class="se">\n</span><span class="s1">thermo;</span><span class="se">\n</span><span class="s1">print,HESSIAN,thermo;}&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;OptTS&#39;</span>
                    <span class="n">orca_options_blocks_dict</span><span class="p">[</span><span class="s1">&#39;Calc_Hess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">%g</span><span class="s2">eom</span>
<span class="s2">    Calc_Hess true # calculation of the exact Hessian before the first opt step</span>
<span class="s2">end               </span>
<span class="s2">&quot;&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;Opt&#39;</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;!Freq&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">user_fine_opt_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">user_fine_opt_convergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fine_opt_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">user_fine_opt_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">fine_opt_convergence</span> <span class="o">=</span> <span class="n">user_fine_opt_convergence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user_fine_opt_convergence</span> \
                        <span class="k">else</span> <span class="n">orca_default_options_dict</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fine_opt_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fine_opt_convergence</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                            <span class="s1">&#39;Orca fine optimization convergence is not specified. Please specify this variable either &#39;</span>
                            <span class="s1">&#39;in the settings.py as default options or in the input file as additional options.&#39;</span><span class="p">)</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;fine_opt_convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fine_opt_convergence</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">user_opt_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">user_opt_convergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opt_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">user_opt_convergence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">opt_convergence</span> <span class="o">=</span> <span class="n">user_opt_convergence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user_opt_convergence</span> \
                        <span class="k">else</span> <span class="n">orca_default_options_dict</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opt_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt_convergence</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                            <span class="s1">&#39;Orca optimization convergence is not specified. Please specify this variable either in &#39;</span>
                            <span class="s1">&#39;the settings.py as default options or in the input file as additional options.&#39;</span><span class="p">)</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;opt_convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt_convergence</span>
                <span class="n">use_num_freq</span> <span class="o">=</span> <span class="n">orca_default_options_dict</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_num_freq&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">use_num_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_num_freq&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">use_num_freq</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">use_num_freq</span><span class="p">:</span>
                    <span class="n">orca_options_keywords_dict</span><span class="p">[</span><span class="s1">&#39;freq_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NumFreq&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using numeric frequencies calculation in Orca. Notice that this job will be &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;very time consuming.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orca_options_keywords_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orca_options_blocks_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                 <span class="n">key1</span><span class="o">=</span><span class="s1">&#39;block&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;sp&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;sp&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;sp&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;energy&#39;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;composite&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, tight, maxstep=5, maxcycles=100)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rocbs-qb3&#39;</span><span class="p">]:</span>
                        <span class="c1"># No analytic 2nd derivatives (FC) for these methods</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(noeigentest, tight)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(calcfc, noeigentest, tight)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;paraskevas&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                    <span class="c1"># convert cbs-qb3-paraskevas to cbs-qb3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;cbs-qb3&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Currently composite methods are only supported in gaussian&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;scan&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">divmod</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scan job got an illegal rotor scan resolution of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">:</span>
                <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">directed_scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span><span class="p">:</span>
                    <span class="n">scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">directed_scan</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A scan job must either get a `scan` or a `directed_scans` argument.</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;Got neither for job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="s1">&#39;ts, &#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;opt=(</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s1">modredundant, calcfc, noeigentest, maxStep=5) scf=(tight, direct) &#39;</span> \
                             <span class="sa">f</span><span class="s1">&#39;integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
                <span class="n">scan_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                    <span class="n">scan_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;D </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s1"> S </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="mi">360</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
                <span class="n">dihedral1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">torsion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">))</span>
                <span class="n">scan_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">$scan</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                    <span class="n">scan_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;tors </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dihedral1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dihedral1</span> <span class="o">+</span> <span class="mf">360.0</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">scan_string</span> <span class="o">+=</span> <span class="s1">&#39;$end</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts</span><span class="se">\n</span><span class="s1">new_minimizer yes&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;minimize</span><span class="se">\n</span><span class="s1">new_minimizer yes&#39;</span>
                <span class="n">dihedral1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">torsion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">))</span>
                <span class="n">scan_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">$constraint_scan</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                    <span class="n">scan_</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">])</span>
                    <span class="n">num_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">360.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">scan_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;    dihedral </span><span class="si">{</span><span class="n">dihedral1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dihedral1</span> <span class="o">+</span> <span class="mf">360.0</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">num_points</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">scan_</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">scan_string</span> <span class="o">+=</span> <span class="s1">&#39;$end</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Currently rotor scan is only supported in Gaussian, QChem, and TeraChem. Got:</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;job type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;software: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;level of theory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">basis</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;directed_scan&#39;</span><span class="p">:</span>
            <span class="c1"># this is either a constrained opt job or an sp job (depends on self.directed_scan_type).</span>
            <span class="c1"># If opt, the dihedrals in self.directed_dihedral are constrained.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, modredundant, calcfc, noeigentest, maxStep=5) scf=(tight, direct)&#39;</span> \
                                     <span class="s1">&#39; integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(modredundant, calcfc, noeigentest, maxStep=5) scf=(tight, direct)&#39;</span> \
                                     <span class="s1">&#39; integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                    <span class="k">for</span> <span class="n">directed_scan</span><span class="p">,</span> <span class="n">directed_dihedral</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span><span class="p">):</span>
                        <span class="n">scan_atoms</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">directed_scan</span><span class="p">])</span>
                        <span class="n">scan_string</span> <span class="o">+=</span> <span class="s1">&#39;D </span><span class="si">{scan}</span><span class="s1"> =</span><span class="si">{dihedral}</span><span class="s1"> B</span><span class="se">\n</span><span class="s1">D </span><span class="si">{scan}</span><span class="s1"> F</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">scan</span><span class="o">=</span><span class="n">scan_atoms</span><span class="p">,</span> <span class="n">dihedral</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directed_dihedral</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="c1"># following https://manual.q-chem.com/5.2/Ch10.S3.SS4.html</span>
                <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;sp&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    CONSTRAINT</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">directed_scan</span><span class="p">,</span> <span class="n">directed_dihedral</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span><span class="p">):</span>
                        <span class="n">scan_atoms</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">directed_scan</span><span class="p">])</span>
                        <span class="n">constraint</span> <span class="o">+=</span> <span class="s1">&#39;        tors </span><span class="si">{scan}</span><span class="s1"> </span><span class="si">{dihedral}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">scan</span><span class="o">=</span><span class="n">scan_atoms</span><span class="p">,</span> <span class="n">dihedral</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directed_dihedral</span><span class="p">))</span>
                    <span class="n">constraint</span> <span class="o">+=</span> <span class="s1">&#39;    ENDCONSTRAINT</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Currently directed rotor scans are only supported in Gaussian and QChem. &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;Got: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="si">}</span><span class="s1"> using the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s1"> level of theory&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ro&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;use=L506&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># xqc will do qc (quadratic convergence) if the job fails w/o it, so use by default</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_args</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;scf=xqc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
            <span class="c1"># TeraChem requires an additional xyz file.</span>
            <span class="c1"># Note: the xyz filename must correspond to the xyz filename specified in TeraChem&#39;s input file!</span>
            <span class="n">save_geo</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;coord&#39;</span><span class="p">,</span> <span class="n">format_</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;irc&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">irc_direction</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">irc_direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The IRC direction must be either &quot;forward&quot; or &quot;reverse&quot;, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">irc_direction</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                <span class="c1"># Note that the Acc2E argument is not available in Gaussian03</span>
                <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;scf=(direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
            <span class="n">job_type_1</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;irc=(CalcAll,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">irc_direction</span><span class="si">}</span><span class="s1">,maxpoints=50,stepsize=7)&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;gsm&#39;</span><span class="p">:</span>  <span class="c1"># TODO</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">solvation_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_type_1</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; SCRF=(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">solvation_method</span><span class="si">}</span><span class="s1">,Solvent=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">solvent</span><span class="si">}</span><span class="s1">)&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">!=</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Can only run MRCI on Molpro, not </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">occ</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Will not execute an MRCI calculation with more than 16 occupied orbitals.&#39;</span>
                               <span class="s1">&#39;Selective occ, closed, core, frozen keyword still not implemented.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_files</span><span class="p">[</span><span class="s1">&#39;mrci&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file_memory</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">),</span>
                                                            <span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                                                            <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not interpret all input file keys in</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">))</span>
                    <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_options_blocks</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> \
                <span class="k">if</span> <span class="s1">&#39;block&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">job_options_keywords</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> \
                <span class="k">if</span> <span class="s1">&#39;keyword&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file_memory</span><span class="p">),</span>
                                               <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                                               <span class="n">slash</span><span class="o">=</span><span class="n">slash</span><span class="p">,</span>
                                               <span class="n">slash_2</span><span class="o">=</span><span class="n">slash_2</span><span class="p">,</span>
                                               <span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">basis</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                               <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                                               <span class="n">cpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">,</span>
                                               <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                               <span class="n">spin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span>
                                               <span class="n">xyz</span><span class="o">=</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">),</span>
                                               <span class="n">job_type_1</span><span class="o">=</span><span class="n">job_type_1</span><span class="p">,</span>
                                               <span class="n">job_type_2</span><span class="o">=</span><span class="n">job_type_2</span><span class="p">,</span>
                                               <span class="n">scan</span><span class="o">=</span><span class="n">scan_string</span><span class="p">,</span>
                                               <span class="n">restricted</span><span class="o">=</span><span class="n">restricted</span><span class="p">,</span>
                                               <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="p">,</span>
                                               <span class="n">shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span>
                                               <span class="n">scan_trsh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_trsh</span><span class="p">,</span>
                                               <span class="n">bath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">,</span>
                                               <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span><span class="p">,</span>
                                               <span class="n">job_options_blocks</span><span class="o">=</span><span class="n">job_options_blocks</span><span class="p">,</span>
                                               <span class="n">job_options_keywords</span><span class="o">=</span><span class="n">job_options_keywords</span><span class="p">,</span>
                                               <span class="n">method_class</span><span class="o">=</span><span class="n">method_class</span><span class="p">,</span>
                                               <span class="n">auxiliary_basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">auxiliary_basis</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                               <span class="n">dispersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span><span class="p">,</span>
                                               <span class="p">)</span> \
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not interpret all input file keys in</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="si">}</span><span class="se">\n</span><span class="s1">Got:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_upload_input_file</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">get_last_modified_time</span><span class="p">(</span>
                    <span class="n">file_path_1</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]))</span>
                <span class="c1"># copy additional input files to local running directory</span>
                <span class="k">for</span> <span class="n">up_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
                        <span class="n">source_path</span> <span class="o">=</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]</span>
                        <span class="n">destination_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">SameFileError</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;input_files&#39;</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">input_files</span><span class="p">[</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_upload_check_file</span><span class="p">(</span><span class="n">local_check_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_upload_submit_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]])</span>
        <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">file_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_upload_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">])</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">file_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">up_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
                    <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;input_files&#39;</span><span class="p">:</span>
                    <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">input_files</span><span class="p">[</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unclear file source for </span><span class="si">{</span><span class="n">up_file</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">. Should either be &quot;path&quot; or &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;&quot;input_files&quot;, got: </span><span class="si">{</span><span class="n">up_file</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;remote&#39;</span><span class="p">],</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;make_x&#39;</span><span class="p">]:</span>
                    <span class="n">ssh</span><span class="o">.</span><span class="n">change_mode</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;+x&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">get_last_modified_time</span><span class="p">(</span>
                <span class="n">remote_file_path_1</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]))</span>

    <span class="k">def</span> <span class="nf">_upload_check_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_check_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">remote_check_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
            <span class="n">local_check_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">local_check_file_path</span> <span class="ow">is</span> <span class="kc">None</span>\
                <span class="k">else</span> <span class="n">local_check_file_path</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_check_file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
                    <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_check_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_check_file_path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;uploading checkpoint file for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># running locally, just copy the check file to the job folder</span>
            <span class="n">new_check_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">local_check_file_path</span><span class="p">,</span> <span class="n">new_check_file_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">SameFileError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_download_output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download ESS output, orbitals check file, and the Gaussian check file, if relevant.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>

            <span class="c1"># download output file</span>
            <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">])</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output file for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> was not downloaded properly&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">get_last_modified_time</span><span class="p">(</span><span class="n">remote_file_path_1</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">)</span>

            <span class="c1"># download orbitals FChk file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;orbitals&#39;</span><span class="p">:</span>
                <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;input.FChk&#39;</span><span class="p">)</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Orbitals FChk file for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> was not downloaded properly &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;(this is not the Gaussian formatted check file...)&#39;</span><span class="p">)</span>

            <span class="c1"># download Gaussian check file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">remote_check_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_check_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Gaussian check file for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> was not downloaded properly&#39;</span><span class="p">)</span>

            <span class="c1"># download Orca .hess hessian file generated by frequency calculations</span>
            <span class="c1"># Hessian is useful when the user would like to project rotors</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;freq&#39;</span><span class="p">:</span>
                <span class="n">remote_hess_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;input.hess&#39;</span><span class="p">)</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_hess_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_hess_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_hess_file</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Orca hessian file for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> was not downloaded properly&#39;</span><span class="p">)</span>

            <span class="c1"># download Lennard_Jones data file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">:</span>
                <span class="n">remote_lj_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;lj.dat&#39;</span><span class="p">)</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_lj_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Lennard-Jones data file for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> was not downloaded properly&#39;</span><span class="p">)</span>

            <span class="c1"># download molpro log file (in addition to the output file)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="n">remote_log_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">])</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_log_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not download Molpro log file for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;(this is not the output file)&#39;</span><span class="p">)</span>

            <span class="c1"># download terachem files (in addition to the output file)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
                <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;scr&#39;</span><span class="p">)</span>
                <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;results.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;output.molden&#39;</span><span class="p">,</span> <span class="s1">&#39;charge.xls&#39;</span><span class="p">,</span> <span class="s1">&#39;charge_mull.xls&#39;</span><span class="p">,</span> <span class="s1">&#39;optlog.xls&#39;</span><span class="p">,</span> <span class="s1">&#39;optim.xyz&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Frequencies.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;I_matrix.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;Mass.weighted.modes.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;moments_of_inertia.dat&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;output.basis&#39;</span><span class="p">,</span> <span class="s1">&#39;output.geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;output.molden&#39;</span><span class="p">,</span> <span class="s1">&#39;Reduced.mass.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;results.dat&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">remote_log_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">local_log_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;scr&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_log_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_log_file_path</span><span class="p">)</span>
                <span class="n">xyz_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;optim.xyz&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">xyz_path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_xyz</span> <span class="o">=</span> <span class="n">xyz_path</span>

<div class="viewcode-block" id="Job.run"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the Job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="si">}</span><span class="s1"> (fine opt)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dihedrals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dihedral</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                         <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="p">]</span> <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directed_dihedrals</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="si">}</span><span class="s1"> (pivots: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">directed_scans</span><span class="si">}</span><span class="s1">, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;dihedrals: </span><span class="si">{</span><span class="n">dihedrals</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivots</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="si">}</span><span class="s1"> (pivots: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pivots</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;writing submit script...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_submit_script</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;writing input file...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_input_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;submitting job...&#39;</span><span class="p">)</span>
            <span class="c1"># submit_job returns job server status and job server id</span>
            <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># running locally</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">submit_job</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Job.delete"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a running Job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleting job </span><span class="si">{name}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;deleting job on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;deleting job locally...&#39;</span><span class="p">)</span>
            <span class="n">delete_job</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Job.determine_job_status"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.determine_job_status">[docs]</a>    <span class="k">def</span> <span class="nf">determine_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the Job&#39;s status. Updates self.job_status.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IOError: If the output file and any additional server information cannot be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;errored&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_job_server_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_job_ess_status</span><span class="p">()</span>  <span class="c1"># populates self.job_status[1], and downloads the output file</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got an IOError when trying to download output file for job </span><span class="si">{0}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_job_info</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got the following information from the server:&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                        <span class="c1"># example:</span>
                        <span class="c1"># slurmstepd: *** JOB 7752164 CANCELLED AT 2019-03-27T00:30:50 DUE TO TIME LIMIT on node096 ***</span>
                        <span class="k">if</span> <span class="s1">&#39;cancelled&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;due to time limit&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Looks like the job was cancelled on </span><span class="si">{0}</span><span class="s1"> due to time limit. &#39;</span>
                                           <span class="s1">&#39;Got: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                            <span class="n">new_max_job_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">-</span> <span class="mi">24</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">&gt;</span> <span class="mi">25</span> <span class="k">else</span> <span class="mi">1</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Setting max job time to </span><span class="si">{0}</span><span class="s1"> (was </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_max_job_time</span><span class="p">,</span>
                                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="n">new_max_job_time</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;errored&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ServerTimeLimit&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Job cancelled by the server since it reached the maximal &#39;</span> \
                                                          <span class="s1">&#39;time limit.&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">raise</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;running&#39;</span></div>

    <span class="k">def</span> <span class="nf">_get_additional_job_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download the additional information of stdout and stderr from the server.</span>
<span class="sd">        stdout and stderr are named out.txt and err.txt respectively</span>
<span class="sd">        submission script in submit.py should contain -o and -e flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines1</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">cluster_soft</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cluster_soft</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;oge&#39;</span><span class="p">,</span> <span class="s1">&#39;sge&#39;</span><span class="p">,</span> <span class="s1">&#39;slurm&#39;</span><span class="p">,</span> <span class="s1">&#39;pbs&#39;</span><span class="p">]:</span>
            <span class="n">local_file_path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;out.txt&#39;</span><span class="p">)</span>
            <span class="n">local_file_path2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;err.txt&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;out.txt&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> 
                                          <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_file_path1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got the following error when trying to download out.txt for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">:&#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;Please check that the submission script contains a -o flag &#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;with stdout named out.txt (e.g., &quot;#SBATCH -o out.txt&quot;).&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;err.txt&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_file_path2</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got the following error when trying to download err.txt for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">:&#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;Please check that the submission script contains a -e flag &#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;with stdout named err.txt (e.g., &quot;#SBATCH -o err.txt&quot;).&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file_path1</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_file_path1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file_path2</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_file_path2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines1</span><span class="p">])</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized cluster software: </span><span class="si">{</span><span class="n">cluster_soft</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">content</span>

    <span class="k">def</span> <span class="nf">_check_job_server_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Possible statuses: `initializing`, `running`, `errored on node xx`, `done`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ssh</span><span class="o">.</span><span class="n">check_job_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">check_job_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_job_ess_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the status of the job ran by the electronic structure software (ESS).</span>
<span class="sd">        Possible statuses: `initializing`, `running`, `errored: {error type / message}`, `unconverged`, `done`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_download_output_file</span><span class="p">()</span>  <span class="c1"># also downloads the check file and orbital file if exist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If running locally, just rename the output file to &quot;output.out&quot; for consistency between software</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="o">=</span> <span class="n">get_last_modified_time</span><span class="p">(</span>
                    <span class="n">file_path_1</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">]))</span>
            <span class="n">rename_output</span><span class="p">(</span><span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">)</span>
            <span class="n">xyz_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;scr&#39;</span><span class="p">,</span> <span class="s1">&#39;optim.xyz&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">xyz_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_xyz</span> <span class="o">=</span> <span class="n">xyz_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_run_time</span><span class="p">()</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">determine_ess_status</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span>
                                                             <span class="n">species_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
                                                             <span class="n">software</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

<div class="viewcode-block" id="Job.troubleshoot_server"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.troubleshoot_server">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshoot server errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">run_job</span> <span class="o">=</span> <span class="n">trsh_job_on_server</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
                                           <span class="n">job_server_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span>
                                           <span class="n">server_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_nodes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">run_job</span><span class="p">:</span>
            <span class="c1"># resubmit job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="Job.determine_run_time"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.determine_run_time">[docs]</a>    <span class="k">def</span> <span class="nf">determine_run_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the run time. Update self.run_time and round to seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span>
            <span class="n">remainder</span> <span class="o">=</span> <span class="n">time_delta</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">&gt;</span> <span class="mf">5e5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time_delta</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">remainder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Job.set_cpu_and_mem"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.set_cpu_and_mem">[docs]</a>    <span class="k">def</span> <span class="nf">set_cpu_and_mem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the amount of cpus and memory based on ESS and cluster software.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_cpu</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpus&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># max cpus per node on server</span>
        <span class="c1"># set to 8 if user did not specify cpu in settings and in ARC input file</span>
        <span class="n">job_cpu_cores</span> <span class="o">=</span> <span class="n">default_job_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;job_cpu_cores&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_cpu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">job_cpu_cores</span> <span class="o">&gt;</span> <span class="n">max_cpu</span><span class="p">:</span>
            <span class="n">job_cpu_cores</span> <span class="o">=</span> <span class="n">max_cpu</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span> <span class="o">=</span> <span class="n">job_cpu_cores</span>

        <span class="n">max_mem</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># max memory per node in GB</span>
        <span class="n">job_max_server_node_memory_allocation</span> <span class="o">=</span> <span class="n">default_job_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;job_max_server_node_memory_allocation&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span> <span class="o">&gt;</span> <span class="n">max_mem</span> <span class="o">*</span> <span class="n">job_max_server_node_memory_allocation</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The memory for job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span><span class="si">}</span><span class="s1"> GB) &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;exceeds </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="n">job_max_server_node_memory_allocation</span><span class="si">}</span><span class="s1">% of the the maximum node memory on &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="si">}</span><span class="s1">. Setting it to </span><span class="si">{</span><span class="n">job_max_server_node_memory_allocation</span> <span class="o">*</span> <span class="n">max_mem</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> GB.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span> <span class="o">=</span> <span class="n">job_max_server_node_memory_allocation</span> <span class="o">*</span> <span class="n">max_mem</span>
            <span class="n">total_submit_script_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mf">1.05</span>  <span class="c1"># MB</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;max_total_job_memory&#39;</span><span class="p">)</span>  <span class="c1"># useful info when trouble shoot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_submit_script_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mf">1.1</span>  <span class="c1"># MB</span>

        <span class="c1"># determine amount of memory in submit script based on cluster job scheduling system</span>
        <span class="n">cluster_software</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cluster_software</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;oge&#39;</span><span class="p">,</span> <span class="s1">&#39;sge&#39;</span><span class="p">]:</span>
            <span class="c1"># In SGE, `-l h_vmem=5000M` specifies the amount of maximum memory required per cpu (all cores) to be 5000 MB.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit_script_memory</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_submit_script_memory</span><span class="p">)</span>  <span class="c1"># MB</span>
        <span class="k">elif</span> <span class="n">cluster_software</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]:</span>
            <span class="c1"># In Slurm, `#SBATCH --mem-per-cpu={2000}` specifies the amount of memory required per cpu core to be 2000 MB.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit_script_memory</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_submit_script_memory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">)</span>  <span class="c1"># MB</span>
        <span class="k">elif</span> <span class="n">cluster_software</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pbs&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit_script_memory</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_submit_script_memory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">)</span>  <span class="c1"># MB</span>
        <span class="c1"># determine amount of memory in job input file based on ESS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;molpro&#39;</span><span class="p">,</span> <span class="s1">&#39;terachem&#39;</span><span class="p">]:</span>
            <span class="c1"># Molpro&#39;s and TeraChem&#39;s memory is per cpu core and in MW (mega word; 1 MW ~= 8 MB; 1 GB = 128 MW)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file_memory</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">]:</span>
            <span class="c1"># Gaussian&#39;s memory is in MB, total for all cpu cores</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file_memory</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;orca&#39;</span><span class="p">]:</span>
            <span class="c1"># Orca&#39;s memory is per cpu core and in MB</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file_memory</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;qchem&#39;</span><span class="p">]:</span>
            <span class="c1"># QChem manages its memory automatically, for now ARC will not intervene</span>
            <span class="c1"># see http://www.q-chem.com/qchem-website/manual/qchem44_manual/CCparallel.html</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file_memory</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_job_memory_gb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Job.set_file_paths"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.set_file_paths">[docs]</a>    <span class="k">def</span> <span class="nf">set_file_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set local and remote job file paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;TSs&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;output.out&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;orbitals.fchk&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_lj_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;lj.dat&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_hess_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;input.hess&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_xyz</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># parentheses don&#39;t play well in folder names:</span>
        <span class="n">species_name_for_remote_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;ARC_Projects&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                            <span class="n">species_name_for_remote_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;ARC_Projects&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                            <span class="n">species_name_for_remote_path</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># self.additional_files_to_upload is a list of dictionaries, each with the following keys:</span>
        <span class="c1"># &#39;name&#39;, &#39;source&#39;, &#39;local&#39;, and &#39;remote&#39;.</span>
        <span class="c1"># If &#39;source&#39; = &#39;path&#39;, then the value in &#39;local&#39; is treated as a file path.</span>
        <span class="c1"># If &#39;source&#39; = &#39;input_files&#39;, then the value in &#39;local&#39; will be taken from the respective entry in inputs.py</span>
        <span class="c1"># If &#39;make_x&#39; is True, the file will be made executable.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;geo.xyz&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;geo.xyz&#39;</span><span class="p">),</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;geo.xyz&#39;</span><span class="p">)})</span>
            <span class="c1"># make the m.x file executable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;m.x&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;input_files&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="s1">&#39;onedmin.molpro.x&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;m.x&#39;</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;qc.mol&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;input_files&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="s1">&#39;onedmin.qc.mol&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;qc.mol&#39;</span><span class="p">)})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                        <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;coord.xyz&#39;</span><span class="p">),</span>
                                                        <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;coord.xyz&#39;</span><span class="p">)})</span></div>

<div class="viewcode-block" id="Job.deduce_software"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.deduce_software">[docs]</a>    <span class="k">def</span> <span class="nf">deduce_software</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce the software to be used.</span>

<span class="sd">        Returns: str</span>
<span class="sd">            The deduced software.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">deduce_software</span><span class="p">(</span><span class="n">job_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">software</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine software for job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;job_num: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;job_type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;level_of_theory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ess_trsh_methods: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;args: </span><span class="si">{</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">available_ess</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to Gaussian&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to QChem&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;orca&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to Orca&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;orca&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;available_ess it to Molpro&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;molpro&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;terachem&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to TeraChem&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;terachem&#39;</span></div>

<div class="viewcode-block" id="Job.add_to_args"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.add_to_args">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">key1</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;keyword&#39;</span><span class="p">,</span>
                    <span class="n">key2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;general&#39;</span><span class="p">,</span>
                    <span class="n">separator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">check_val</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add arguments to self.args in a nested dictionary under self.args[key1][key2].</span>

<span class="sd">        Args:</span>
<span class="sd">            val (str): The value to add.</span>
<span class="sd">            key1 (str, optional): Key1.</span>
<span class="sd">            key2 (str, optional): Key2.</span>
<span class="sd">            separator (str, optional): A separator (e.g., ``&#39; &#39;``  or ``&#39;\\n&#39;``)</span>
<span class="sd">                                       to apply between existing values and new values.</span>
<span class="sd">            check_val (bool, optional): Only append ``val`` if it doesn&#39;t exist in the dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">separator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">key1</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="k">if</span> <span class="n">key1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_val</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key1</span><span class="p">][</span><span class="n">key2</span><span class="p">]):</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="n">separator</span> <span class="k">if</span> <span class="n">key2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key1</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">val</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2022, Alon Grinberg Dana

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>